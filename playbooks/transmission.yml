- hosts: dzhus.org

  vars:
    transmission_user: debian-transmission
    transmission_group: "{{ transmission_user }}"
    transmission_dir_prefix: "/home/{{ transmission_user }}"
    transmission_config_dir: "{{ transmission_dir_prefix }}/.config/transmission-daemon"
    transmission_downloads_dir: "{{ transmission_dir_prefix }}/downloads"
    transmission_incomplete_dir: "{{ transmission_dir_prefix }}/incomplete"
    transmission_watch_dir: "{{ transmission_dir_prefix }}/watch"

  tasks:
    - apt_key:
        id: A37DA909AE70535824D82620976B5901365C5CA1
        keyserver: hkp://keyserver.ubuntu.com:80

    - apt_repository:
        repo: deb http://ppa.launchpad.net/transmissionbt/ppa/ubuntu {{ ansible_lsb.codename }} main
        update_cache: yes

    - apt:
        name: transmission-daemon=2.92*
        update_cache: yes
        cache_valid_time: 300
      notify:
        - Reload Transmission
        - Restart Transmission

    # Group-writable Transmission home dir so that Syncthing could
    # put files to watch-dir
    - name: Transmission user home folder
      file:
        dest: "{{ transmission_watch_dir | dirname }}"
        state: directory
        group: "{{ transmission_group }}"
        owner: "{{ transmission_user }}"
        mode:  "0775"

    - name: Transmission folders
      file:
        dest: "{{ item }}"
        state: directory
        group: "{{ transmission_group }}"
        owner: "{{ transmission_user }}"
        mode:  "4775"
      with_items:
        - "{{ transmission_downloads_dir }}"
        - "{{ transmission_incomplete_dir }}"
        - "{{ transmission_watch_dir }}"

    - user:
        name: "{{ syncthing_user }}"
        groups: "{{ transmission_group }}"
        append: yes

    - name: Transmission config directory
      file:
        dest: "{{ transmission_config_dir }}"
        state: directory
        group: "{{ transmission_group }}"
        owner: "{{ transmission_user }}"

    - name: Transmission settings
      template:
        dest: "{{ transmission_config_dir }}/settings.json"
        src: files/transmission-settings.json.j2
      notify: Reload Transmission

    - systemd:
        name: transmission-daemon
        enabled: yes
        state: started

  handlers:
    - name: Reload Transmission
      service:
        name: transmission-daemon
        state: reloaded

    - name: Restart Transmission
      service:
        name: transmission-daemon
        state: restarted
